{% extends "base.html" %}

{% block title %}Portfolio - Equity Research Dashboard{% endblock %}

{% block content %}
<div class="portfolio-container">
    <!-- Portfolio Overview -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card dashboard-card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-briefcase"></i> Portfolio Overview
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <div class="portfolio-metric">
                                <div class="metric-title">Total Value</div>
                                <div class="metric-value" id="total-value">$0.00</div>
                                <div class="metric-change" id="total-change">+0.00%</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="portfolio-metric">
                                <div class="metric-title">Total Return</div>
                                <div class="metric-value" id="total-return">$0.00</div>
                                <div class="metric-change" id="total-return-percent">+0.00%</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="portfolio-metric">
                                <div class="metric-title">Daily P&L</div>
                                <div class="metric-value" id="daily-pnl">$0.00</div>
                                <div class="metric-change" id="daily-pnl-percent">+0.00%</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="portfolio-metric">
                                <div class="metric-title">Sharpe Ratio</div>
                                <div class="metric-value" id="sharpe-ratio">0.00</div>
                                <div class="metric-change" id="sharpe-change">--</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Portfolio Management -->
    <div class="row mb-4">
        <div class="col-md-8">
            <div class="card dashboard-card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-list-ul"></i> Portfolio Holdings
                    </h5>
                    <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addStockModal">
                        <i class="bi bi-plus"></i> Add Stock
                    </button>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover" id="portfolio-table">
                            <thead>
                                <tr>
                                    <th>Symbol</th>
                                    <th>Shares</th>
                                    <th>Avg Price</th>
                                    <th>Current Price</th>
                                    <th>Market Value</th>
                                    <th>Unrealized P&L</th>
                                    <th>Weight</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="portfolio-holdings">
                                <tr>
                                    <td colspan="8" class="text-center text-muted">
                                        No holdings in portfolio. Add stocks to get started.
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-4">
            <div class="card dashboard-card">
                <div class="card-header">
                    <h6 class="card-title mb-0">
                        <i class="bi bi-pie-chart"></i> Asset Allocation
                    </h6>
                </div>
                <div class="card-body">
                    <div id="allocation-chart" class="chart"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Portfolio Performance -->
    <div class="row mb-4">
        <div class="col-md-8">
            <div class="card dashboard-card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-graph-up"></i> Performance Chart
                    </h5>
                </div>
                <div class="card-body">
                    <div id="performance-chart" class="chart"></div>
                </div>
            </div>
        </div>
        
        <div class="col-md-4">
            <div class="card dashboard-card">
                <div class="card-header">
                    <h6 class="card-title mb-0">
                        <i class="bi bi-shield-check"></i> Risk Metrics
                    </h6>
                </div>
                <div class="card-body">
                    <div class="risk-metrics">
                        <div class="risk-metric">
                            <span class="risk-label">Volatility</span>
                            <span class="risk-value" id="portfolio-volatility">--</span>
                        </div>
                        <div class="risk-metric">
                            <span class="risk-label">Beta</span>
                            <span class="risk-value" id="portfolio-beta">--</span>
                        </div>
                        <div class="risk-metric">
                            <span class="risk-label">VaR (95%)</span>
                            <span class="risk-value" id="portfolio-var">--</span>
                        </div>
                        <div class="risk-metric">
                            <span class="risk-label">Max Drawdown</span>
                            <span class="risk-value" id="portfolio-drawdown">--</span>
                        </div>
                        <div class="risk-metric">
                            <span class="risk-label">Sortino Ratio</span>
                            <span class="risk-value" id="portfolio-sortino">--</span>
                        </div>
                        <div class="risk-metric">
                            <span class="risk-label">Calmar Ratio</span>
                            <span class="risk-value" id="portfolio-calmar">--</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Portfolio Optimization -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card dashboard-card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-gear"></i> Portfolio Optimization
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="optimization-controls">
                                <h6>Optimization Method</h6>
                                <select class="form-select mb-3" id="optimization-method">
                                    <option value="max_sharpe">Maximum Sharpe Ratio</option>
                                    <option value="min_volatility">Minimum Volatility</option>
                                    <option value="equal_weight">Equal Weight</option>
                                    <option value="risk_parity">Risk Parity</option>
                                </select>
                                
                                <h6>Risk Tolerance</h6>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="riskTolerance" id="conservative" value="conservative">
                                    <label class="form-check-label" for="conservative">Conservative</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="riskTolerance" id="moderate" value="moderate" checked>
                                    <label class="form-check-label" for="moderate">Moderate</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="riskTolerance" id="aggressive" value="aggressive">
                                    <label class="form-check-label" for="aggressive">Aggressive</label>
                                </div>
                                
                                <button class="btn btn-primary mt-3" onclick="optimizePortfolio()">
                                    <i class="bi bi-play"></i> Optimize Portfolio
                                </button>
                            </div>
                        </div>
                        
                        <div class="col-md-8">
                            <div id="optimization-results">
                                <div class="text-muted text-center">
                                    Click "Optimize Portfolio" to see optimization results
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Correlation Matrix -->
    <div class="row">
        <div class="col-12">
            <div class="card dashboard-card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-grid-3x3"></i> Correlation Matrix
                    </h5>
                </div>
                <div class="card-body">
                    <div id="correlation-chart" class="chart"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Stock Modal -->
<div class="modal fade" id="addStockModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Stock to Portfolio</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addStockForm">
                    <div class="mb-3">
                        <label for="stock-symbol-input" class="form-label">Stock Symbol</label>
                        <input type="text" class="form-control" id="stock-symbol-input" placeholder="e.g., AAPL" required>
                    </div>
                    <div class="mb-3">
                        <label for="shares-input" class="form-label">Number of Shares</label>
                        <input type="number" class="form-control" id="shares-input" placeholder="100" step="0.01" required>
                    </div>
                    <div class="mb-3">
                        <label for="price-input" class="form-label">Purchase Price per Share</label>
                        <input type="number" class="form-control" id="price-input" placeholder="150.00" step="0.01" required>
                    </div>
                    <div class="mb-3">
                        <label for="date-input" class="form-label">Purchase Date</label>
                        <input type="date" class="form-control" id="date-input" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="addStockToPortfolio()">Add Stock</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Stock Modal -->
<div class="modal fade" id="editStockModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Stock Position</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editStockForm">
                    <input type="hidden" id="edit-symbol">
                    <div class="mb-3">
                        <label for="edit-shares-input" class="form-label">Number of Shares</label>
                        <input type="number" class="form-control" id="edit-shares-input" step="0.01" required>
                    </div>
                    <div class="mb-3">
                        <label for="edit-price-input" class="form-label">Average Price per Share</label>
                        <input type="number" class="form-control" id="edit-price-input" step="0.01" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="updateStockPosition()">Update</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Portfolio-specific functionality
    document.addEventListener('DOMContentLoaded', function() {
        // Set current date as default for new purchases
        document.getElementById('date-input').value = new Date().toISOString().split('T')[0];
        
        // Load portfolio data
        loadPortfolioData();
        
        // Set up form submission
        document.getElementById('addStockForm').addEventListener('submit', function(e) {
            e.preventDefault();
            addStockToPortfolio();
        });
    });
    
    // Load portfolio data
    async function loadPortfolioData() {
        try {
            const response = await fetch('/api/portfolio');
            if (response.ok) {
                const data = await response.json();
                updatePortfolioDisplay(data);
            }
        } catch (error) {
            console.error('Error loading portfolio data:', error);
        }
    }
    
    // Update portfolio display
    function updatePortfolioDisplay(data) {
        // Update portfolio metrics
        if (data.metrics) {
            document.getElementById('total-value').textContent = formatCurrency(data.metrics.totalValue);
            document.getElementById('total-change').textContent = formatPercent(data.metrics.totalChange);
            document.getElementById('total-return').textContent = formatCurrency(data.metrics.totalReturn);
            document.getElementById('total-return-percent').textContent = formatPercent(data.metrics.totalReturnPercent);
            document.getElementById('daily-pnl').textContent = formatCurrency(data.metrics.dailyPnL);
            document.getElementById('daily-pnl-percent').textContent = formatPercent(data.metrics.dailyPnLPercent);
            document.getElementById('sharpe-ratio').textContent = data.metrics.sharpeRatio.toFixed(3);
        }
        
        // Update holdings table
        if (data.holdings) {
            updateHoldingsTable(data.holdings);
        }
        
        // Update charts
        if (data.charts) {
            updatePortfolioCharts(data.charts);
        }
        
        // Update risk metrics
        if (data.riskMetrics) {
            updateRiskMetrics(data.riskMetrics);
        }
    }
    
    // Update holdings table
    function updateHoldingsTable(holdings) {
        const tbody = document.getElementById('portfolio-holdings');
        
        if (holdings.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="8" class="text-center text-muted">
                        No holdings in portfolio. Add stocks to get started.
                    </td>
                </tr>
            `;
            return;
        }
        
        tbody.innerHTML = holdings.map(holding => `
            <tr>
                <td><strong>${holding.symbol}</strong></td>
                <td>${holding.shares.toFixed(2)}</td>
                <td>${formatCurrency(holding.avgPrice)}</td>
                <td>${formatCurrency(holding.currentPrice)}</td>
                <td>${formatCurrency(holding.marketValue)}</td>
                <td class="${holding.unrealizedPnL >= 0 ? 'text-success' : 'text-danger'}">
                    ${formatCurrency(holding.unrealizedPnL)}
                </td>
                <td>${formatPercent(holding.weight)}</td>
                <td>
                    <button class="btn btn-sm btn-outline-primary" onclick="editStock('${holding.symbol}')">
                        <i class="bi bi-pencil"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-danger" onclick="removeStock('${holding.symbol}')">
                        <i class="bi bi-trash"></i>
                    </button>
                </td>
            </tr>
        `).join('');
    }
    
    // Update portfolio charts
    function updatePortfolioCharts(charts) {
        if (charts.allocation) {
            Plotly.newPlot('allocation-chart', charts.allocation.data, charts.allocation.layout);
        }
        
        if (charts.performance) {
            Plotly.newPlot('performance-chart', charts.performance.data, charts.performance.layout);
        }
        
        if (charts.correlation) {
            Plotly.newPlot('correlation-chart', charts.correlation.data, charts.correlation.layout);
        }
    }
    
    // Update risk metrics
    function updateRiskMetrics(metrics) {
        document.getElementById('portfolio-volatility').textContent = formatPercent(metrics.volatility);
        document.getElementById('portfolio-beta').textContent = metrics.beta.toFixed(3);
        document.getElementById('portfolio-var').textContent = formatPercent(metrics.var);
        document.getElementById('portfolio-drawdown').textContent = formatPercent(metrics.maxDrawdown);
        document.getElementById('portfolio-sortino').textContent = metrics.sortinoRatio.toFixed(3);
        document.getElementById('portfolio-calmar').textContent = metrics.calmarRatio.toFixed(3);
    }
    
    // Add stock to portfolio
    async function addStockToPortfolio() {
        const symbol = document.getElementById('stock-symbol-input').value.toUpperCase();
        const shares = parseFloat(document.getElementById('shares-input').value);
        const price = parseFloat(document.getElementById('price-input').value);
        const date = document.getElementById('date-input').value;
        
        if (!symbol || !shares || !price || !date) {
            showError('Please fill in all fields');
            return;
        }
        
        try {
            const response = await fetch('/api/portfolio/add', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    symbol: symbol,
                    shares: shares,
                    price: price,
                    date: date
                })
            });
            
            if (response.ok) {
                showSuccess('Stock added to portfolio');
                bootstrap.Modal.getInstance(document.getElementById('addStockModal')).hide();
                document.getElementById('addStockForm').reset();
                loadPortfolioData();
            } else {
                throw new Error('Failed to add stock');
            }
        } catch (error) {
            showError('Error adding stock to portfolio: ' + error.message);
        }
    }
    
    // Edit stock position
    function editStock(symbol) {
        // This would typically load the current position data
        document.getElementById('edit-symbol').value = symbol;
        // For now, we'll just show the modal
        new bootstrap.Modal(document.getElementById('editStockModal')).show();
    }
    
    // Update stock position
    async function updateStockPosition() {
        const symbol = document.getElementById('edit-symbol').value;
        const shares = parseFloat(document.getElementById('edit-shares-input').value);
        const price = parseFloat(document.getElementById('edit-price-input').value);
        
        try {
            const response = await fetch('/api/portfolio/update', {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    symbol: symbol,
                    shares: shares,
                    avgPrice: price
                })
            });
            
            if (response.ok) {
                showSuccess('Position updated');
                bootstrap.Modal.getInstance(document.getElementById('editStockModal')).hide();
                loadPortfolioData();
            } else {
                throw new Error('Failed to update position');
            }
        } catch (error) {
            showError('Error updating position: ' + error.message);
        }
    }
    
    // Remove stock from portfolio
    async function removeStock(symbol) {
        if (!confirm(`Are you sure you want to remove ${symbol} from your portfolio?`)) {
            return;
        }
        
        try {
            const response = await fetch(`/api/portfolio/remove/${symbol}`, {
                method: 'DELETE'
            });
            
            if (response.ok) {
                showSuccess('Stock removed from portfolio');
                loadPortfolioData();
            } else {
                throw new Error('Failed to remove stock');
            }
        } catch (error) {
            showError('Error removing stock: ' + error.message);
        }
    }
    
    // Optimize portfolio
    async function optimizePortfolio() {
        const method = document.getElementById('optimization-method').value;
        const riskTolerance = document.querySelector('input[name="riskTolerance"]:checked').value;
        
        try {
            showLoading(true);
            
            const response = await fetch('/api/portfolio/optimize', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    method: method,
                    riskTolerance: riskTolerance
                })
            });
            
            if (response.ok) {
                const result = await response.json();
                displayOptimizationResults(result);
            } else {
                throw new Error('Failed to optimize portfolio');
            }
        } catch (error) {
            showError('Error optimizing portfolio: ' + error.message);
        } finally {
            showLoading(false);
        }
    }
    
    // Display optimization results
    function displayOptimizationResults(results) {
        const container = document.getElementById('optimization-results');
        
        container.innerHTML = `
            <div class="row">
                <div class="col-md-6">
                    <h6>Optimization Summary</h6>
                    <div class="optimization-metrics">
                        <div class="metric">
                            <span class="label">Expected Return:</span>
                            <span class="value">${formatPercent(results.expectedReturn)}</span>
                        </div>
                        <div class="metric">
                            <span class="label">Volatility:</span>
                            <span class="value">${formatPercent(results.volatility)}</span>
                        </div>
                        <div class="metric">
                            <span class="label">Sharpe Ratio:</span>
                            <span class="value">${results.sharpeRatio.toFixed(3)}</span>
                        </div>
                        <div class="metric">
                            <span class="label">Max Drawdown:</span>
                            <span class="value">${formatPercent(results.maxDrawdown)}</span>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <h6>Optimal Weights</h6>
                    <div class="weights-list">
                        ${Object.entries(results.weights).map(([symbol, weight]) => `
                            <div class="weight-item">
                                <span class="symbol">${symbol}</span>
                                <span class="weight">${formatPercent(weight)}</span>
                            </div>
                        `).join('')}
                    </div>
                    <button class="btn btn-success btn-sm mt-3" onclick="applyOptimization()">
                        Apply Optimization
                    </button>
                </div>
            </div>
        `;
    }
    
    // Apply optimization
    async function applyOptimization() {
        try {
            const response = await fetch('/api/portfolio/apply-optimization', {
                method: 'POST'
            });
            
            if (response.ok) {
                showSuccess('Portfolio optimization applied');
                loadPortfolioData();
            } else {
                throw new Error('Failed to apply optimization');
            }
        } catch (error) {
            showError('Error applying optimization: ' + error.message);
        }
    }
</script>
{% endblock %}
